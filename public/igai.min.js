// Lấy các tham số từ URL
const searchParams = new URLSearchParams(location.search);
const ref = searchParams.get("ref");
const paramA = searchParams.get("a");
const currentUrl = new URL(location.href);
const doc = document;

// Hàm truy cập nhanh phần tử DOM theo id
function getEl(id) {
    return doc.getElementById(id);
}

// Nếu có ref, lưu vào localStorage
if (ref) {
    localStorage.setItem("r", ref);
}

// Hiển thị/ẩn phần tử dựa vào sự tồn tại của tham số 'a'
["a", "d"].forEach(id => {
    getEl(id).style.display = paramA ? "inline-block" : "none";
});
getEl("c").style.display = paramA ? "none" : "inline-block";

// Cập nhật href cho nút 'd'
currentUrl.search = "";
getEl("d").href = currentUrl.toString();

// Form xử lý
const form = getEl("c");
function createOption(value, text, selectId) {
    const option = doc.createElement("option");
    option.value = value;
    option.textContent = text;
    getEl(selectId).appendChild(option);
}

// Gắn sự kiện submit cho form
form.addEventListener("submit", function (e) {
    e.preventDefault();
    const actionUrl = new URL(form.action, location.origin);
    const emailInput = getEl("e");

    // Thêm tham số từ nút submit
    actionUrl.searchParams.set("t", e.submitter?.name);
    if (emailInput && emailInput.value) {
        actionUrl.searchParams.set("email", emailInput.value);
    }

    // Chuyển trang
    location.href = actionUrl.toString();
});

// Tạo danh sách lựa chọn cho nghề nghiệp và giới tính
const candidatePrefix = "Candidate in ";
const roles = [
    [3, "Loan Default"], [4, "Fraud Detection"], [5, "Debt Repayment Probability"], [6, "Mental Wellness"],
    [7, "Employee Churn"], [8, "Candidate Success in General"], [9, candidatePrefix + "Construction"],
    [10, candidatePrefix + "Management"], [11, candidatePrefix + "Programming"],
    [12, candidatePrefix + "Sales and Marketing"], [13, candidatePrefix + "Sales"],
    [14, candidatePrefix + "Marketing"], [15, candidatePrefix + "AI Content"],
    [16, candidatePrefix + "Legal Finance"], [17, candidatePrefix + "Design"],
    [18, candidatePrefix + "Accounting"], [19, candidatePrefix + "Recruitment"],
    [20, candidatePrefix + "Operations"], [21, candidatePrefix + "Customer Service"],
    [22, candidatePrefix + "Technical Support"], [24, candidatePrefix + "Merchant Acquisition"],
    [23, candidatePrefix + "Telesales"],
];
roles.forEach(([value, text]) => createOption(value, text, "v"));

// Tạo lựa chọn giới tính
[["male", "Male"], ["female", "Female"]].forEach(([value, text]) => createOption(value, text, "g"));

// Tạo lựa chọn độ tuổi từ 18 đến 100
for (let age = 18; age <= 100; age++) {
    createOption(age, age, "y");
}

// Nếu có param 'a', xử lý hiển thị referral link
if (paramA) {
    const domain = ".insightgenesis.ai/";
    const referralUrl = `https://panel${domain}?ref=${paramA}`;
    const linkElem = getEl("k");

    linkElem.textContent = referralUrl;

    linkElem.addEventListener("click", async (e) => {
        e.preventDefault();
        await navigator.clipboard.writeText(referralUrl);
        linkElem.textContent = "Copied!";
    });

    const storedRef = localStorage.getItem("r");
    if (storedRef) {
        fetch(`https://api${domain}ref?t=${paramA}&f=${storedRef}`);
    }
}

// Gắn token khi nhấn nút "s"
doc.getElementById("s").onclick = function () {
    localStorage.setItem("s", "c5UqVPihwtydCKe57YJPtpyE2ryB9AJn");
};
